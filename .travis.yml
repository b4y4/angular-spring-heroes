dist: trusty
sudo: required

stages:
  - build
  - name: deploy-pr
    if: type IN (pull_request)

jobs:
  include:
    - stage: build
      script:
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - export DOCKER_TAG=`if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then echo "pr-$TRAVIS_PULL_REQUEST"; elif [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH ; fi`
      - docker build -t $DOCKER_ORG/angular-spring-heroes:$DOCKER_TAG .
      - docker images
      - docker push $DOCKER_ORG/angular-spring-heroes:$DOCKER_TAG
    - stage: deploy-pr
      before_script:
      - curl -L -o oc.tgz https://github.com/openshift/origin/releases/download/v3.7.2/openshift-origin-client-tools-v3.7.2-282e43f-linux-64bit.tar.gz
      - tar --strip-components=1 -xzf oc.tgz
      - rm oc.tgz
      - curl -L -o helm.tgz https://storage.googleapis.com/kubernetes-helm/helm-v2.9.1-linux-amd64.tar.gz
      - tar --strip-components=1 -xzf helm.tgz
      - rm helm.tgz
      - PATH=`pwd`:$PATH
      script:
      - export HELM_RELEASE="pr-$TRAVIS_PULL_REQUEST"
      - oc login ${OPENSHIFT_URL} --token=${OPENSHIFT_TOKEN}
      - oc project ${OPENSHIFT_PROJECT}
      - helm init --upgrade --tiller-namespace ${OPENSHIFT_PROJECT} --service-account tiller
      - helm repo add porscheinformatik https://porscheinformatik.github.io/helm-charts/
      - helm dep up charts/angular-spring-heroes/
      - helm upgrade --tiller-namespace ${OPENSHIFT_PROJECT} --install --set image.tag=${HELM_RELEASE} ${HELM_RELEASE} charts/angular-spring-heroes
